# Course: Mastering RTOS: Hands on FreeRTOS and STM32Fx with Debugging

Notes and Code Author: Leandro D. Medus  
August 2021


## Index

1. Overview of the course
2. RTOS Introduction
3. Development board used in our courses
4. IDE install (OpenSTM32 System Workbench)     [misc]
5. Downloading and Installing FreeRTOS          [misc]
6. Creating FreeRTOS based project for STM32 MCUs
7. FreeRTOS Task Creation
8. FreeRTOS Hello World App and Testing on hardware
9. Semi hosting and UART setup
10. FreeRTOS app debugging using SEGGER SystemView Tools
11. IDLE Task and Timer Svc Task of FreerRTOS
12. FreeRTOS Scheduler
13. FreeRTOS and ARM Cortex Mx Arch. Specific details
14. Context switching
15. Exercise  Button and LED Task and Interrupt Coding
16. FreeRTOS Task Notification
17. FreeRTOS Licensing model and API interface
18. Overview of FreeRTOS Memory manage, STACK and Synchronization services
19. FreeRTOS Kernel Coding Style
20. FreeRTOS Task Deletion
21. ARM Cortex M Interrupt Priority and  FreeRTOS Task Priority
22. Interrupt safe APIs and Task yielding
23. FreeRTOS Task States
24. FreeRTOS  Importance of Delay APIs
25. FreeRTOS Hook Functions
26. FreeRTOS Scheduling Policies
27. FreeRTOS Queue Management
28. Semaphore for Synchronization, mutual exclusion and Interrupt Management
29. Mutual exclusion
30. FreeRTOS+Simulator

## Some notes about the tools

### Generated project structure
Regarding STM32 Cube Mx Sorftware, this is the basic structure of the source code generated:

* Core: main source code
    * Inc 
    * Src
    * Startup
* Drivers: HAL

Some projects files in json format: 
* .cproject: eclipse configuration with paths and files, linker configuration, etc.
* .mxproject: configuration and output paths used in for the specific cube mx project
* .project: cube ide config?
* poc_uart.ioc: stm32 cube mx project (I think this is the essentianl). All the values selected by the user in the tool.

### What to include in the gitignore:

> From the project
```
*/Core/Startup/*
*/Drivers/*
```

> From Core/Inc:
```
    stm32_assert.h: autogenerated
    #stm32l5xx_hal_conf.h: I've kept it becase is an easy way to see what modules have been included with the tool.
```

> From Core/Src:
```
    system_stm32l5xx.c
    syscalls.c
    sysmem.c
```

### Some default labels for NUCLEO-L552ZE-Q

Remember that this board is based on the STM32L552ZETxQ chip

**Pins and default labels**:

* In / Out: 
    * PC13: USER_BUTTON 
    * PB7: LED_BLUE
    * PA9: LED_RED
    * PC7: LED_GREEN

* Serial:
    * PG7: ST-LINK_VCP_TX
    * PG8: ST-LINK_VCP_RX

* Debug: 
    * PA13: DEBUG_JTMS-SWDIO
    * PA14: DEBUG_JTCK-SWCLK
    * PB3:  DEBUG_JTDO-SWO

* ADC: 
    * PC2: ADC1_IN3

* USB-C: (USB-C Power Delivery feature)
    * PA11: USB_DM
    * PB5:  UCPD_DBN (UCPD Dead Battery)
    * PA15: UCPD_CC1 (Configuration Channel 1)
    * PB15: UCPD_CC2 (Configuration Channel 2)
    * PB14: UCPD_FLT (UCPD_FAULT)

* Oscillator:
    * PC14: RCC_OSC32_IN
    * PC15: RCC_OSC32_OUT



### Setting up a FreeRTOS project

Add the folder:
* FreeRTOS
* Config
* SEGGER

After refreshing the project, always check that if the folder were copied from another place, that in eclipse, in properties, the resources were not excluded from the building process. This happens when a folder is included in the project directory without being added manually inside eclipse.

* In **C/C++ Build** uncheck **Exclude resource for build**

Always use: **Add > Select workspace > Select**

ProjectName > Properties > C/C++ Build > Settings > **MCU GCC Compiler > Includes**
    * SEGGER/OS
    * SEGGER/Config
    * /SEGGER/SEGGER
    * Config
    * FreeRTOS/CMSIS_RTOS_V2
    * FreeRTOS/include
    * FreeRTOS/portable/GCC/ARM_CM33_NTZ/non_secure

ProjectName > Properties > C/C++ Build > Settings > **MCU GCC Assembler > Includes**
    * SEGGER/Config


**MORE IMPORTANT** 

Since the project is created with the Cube MX tool from STM, all the source code is generated automatically. This produces that when we include FreeRTOS the systic hander for the interruption is coded in the FreeRTOS directory. As a consequence, we have to comment the code inside the file **stm32l5xx_it.c** under the section **Cortex Processor Interruption and Exception Handlers**.


### Segger continuous recording

Once the Jlink SW package is installed, you can lauch the reflash utility.

```
[1] Upgrade to J-Link
Preparing for FW update (can take up to 10 seconds)...O.K.
Identifying ST-LINK variant...O.K.: ST-LINK/V2-1
Performing firmware update...O.K.
```
Now J-Link software is running in the board.

You don't need to close the window.


Open SeegerViewer. Menu **Target** \> **Start recording**.  
* Select J-Link
> If everything is working propperly a configuration windows will open. If not, unplug the board and plug it again.
* Config:
    * J-Link Connection: USB
    * Target Connection: Cortex-M33
    * Target interface: SWD
    * Interface speed \[KHz\]: 8000
    * RTT Control Block Detection:
        * Address (could fail)
        * Search range: 0x20000000 256000

In the search range we use the base address of the SRAM and the size to search for the RTT buffer.

**To restore the ST-Link firmware, use again the reflash utility**
```
[3] Restore ST-Link
```
**Note**: If the board is not working properly after reflashing the ST-Link SW, just use the firmware for the specific board. In this case, **stsw-link007** (firmware programmer).